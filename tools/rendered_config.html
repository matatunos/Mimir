    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="csrf-token" content="809efcadd2ab1cd3eaeb7aef6e3a241202eb4186c1b080a0821421d3ca659ac4">
        <title>Configuración - Mimir</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="https://files.favala.es/assets/css/style.css">
        <style>
        :root {
            /* Override brand colors from configuration */
            --brand-primary: #667eea !important;
            --brand-secondary: #764ba2 !important;
            --brand-accent: #667eea !important;
            
            /* Update dependent colors */
            --primary-color: #667eea !important;
            --primary-dark: #5164bb !important;
            --primary-light: #84a3ff !important;
            --secondary-color: #764ba2 !important;
            --accent-color: #667eea !important;
            --info-color: #667eea !important;
            --primary: #667eea !important;
        }
        
        /* Ensure proper text contrast on buttons */
        .btn-primary,
        .btn.btn-primary,
        button.btn-primary {
            background: #667eea !important;
            color: #000000 !important;
        }
        
        .btn-primary:hover,
        .btn.btn-primary:hover,
        button.btn-primary:hover {
            background: #5164bb !important;
            color: #000000 !important;
        }
        
        .btn-accent,
        .btn.btn-accent {
            background: #667eea !important;
            color: #000000 !important;
        }
        </style>
        <style>
        /* When configuration protection is active, make readonly form controls appear in medium-gray */
        .config-protected input[readonly],
        .config-protected textarea[readonly],
        .config-protected select[disabled],
        .config-protected input[disabled] {
            color: #6b6b6b !important;
            opacity: 1 !important;
        }
        /* Also dim placeholder text slightly for readonly fields */
        .config-protected input[readonly]::placeholder,
        .config-protected textarea[readonly]::placeholder {
            color: #8a8a8a !important;
        }
        /* Floating, centered protection banner */
        .config-protection-floating {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 99999;
            background: rgba(255,255,255,0.98);
            color: #dc2626;
            border: 1px solid rgba(220,38,38,0.15);
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 18px 48px rgba(0,0,0,0.28);
            display: flex;
            gap: 0.75rem;
            align-items: center;
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
            min-width: 320px;
            max-width: 90vw;
        }
        .config-protection-floating i { font-size: 1.6rem; color: #dc2626; }
        @media (max-width: 540px) {
            .config-protection-floating { font-size: 1rem; padding: 0.75rem 1rem; }
            .config-protection-floating i { font-size: 1.2rem; }
        }
        </style>
        <style>
        /* Compact-mode transition and global compact styles (applies when user enables compact view) */
        .compact-mode .users-table-compact th,
        .compact-mode .users-table-compact td {
            transition: padding 220ms ease, font-size 220ms ease, max-width 220ms ease;
        }
        .compact-mode .users-table-compact .truncate {
            transition: max-width 220ms ease;
        }
        /* Smooth transition for buttons area */
        .compact-mode .btn { transition: padding 180ms ease, font-size 180ms ease; }
        </style>
    </head>
    <body >
                <div class="app-container">
                <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                        <polyline points="13 2 13 9 20 9"></polyline>
                    </svg>
                                <span>Mimir</span>
            </div>
        </div>
        
        <div class="sidebar-menu">
                            <!-- Admin Menu -->
                <div class="menu-section">
                    <div class="menu-section-title">Panel</div>
                    <a href="https://files.favala.es/admin/index.php" class="menu-item ">
                        <i class="fas fa-chart-line"></i> Dashboard
                    </a>
                </div>
                
                <div class="menu-section">
                    <div class="menu-section-title">Gestión</div>
                    <a href="https://files.favala.es/admin/users.php" class="menu-item ">
                        <i class="fas fa-users"></i> Usuarios & 2FA
                    </a>
                    <a href="https://files.favala.es/admin/files.php" class="menu-item ">
                        <i class="fas fa-folder"></i> Archivos
                    </a>
                    <a href="https://files.favala.es/admin/orphan_files.php" class="menu-item ">
                        <i class="fas fa-box"></i> Archivos huérfanos
                    </a>
                    <a href="https://files.favala.es/admin/expired_files.php" class="menu-item ">
                        <i class="fas fa-clock"></i> Archivos Expirados
                    </a>
                    <a href="https://files.favala.es/admin/shares.php" class="menu-item ">
                        <i class="fas fa-share-alt"></i> Comparticiones
                    </a>
                    <a href="https://files.favala.es/admin/invitations.php" class="menu-item ">
                        <i class="fas fa-envelope-open-text"></i> Invitaciones
                    </a>
                    <a href="https://files.favala.es/admin/logs.php" class="menu-item ">
                        <i class="fas fa-clipboard-list"></i> Registros
                    </a>
                    <a href="https://files.favala.es/admin/forensic_logs.php" class="menu-item ">
                        <i class="fas fa-search"></i> Análisis Forense
                    </a>
                </div>
                
                <div class="menu-section">
                    <div class="menu-section-title">Sistema</div>
                    <a href="https://files.favala.es/admin/config.php" class="menu-item active">
                        <i class="fas fa-cog"></i> Configuración
                    </a>
                </div>
                
                <div class="menu-section">
                    <div class="menu-section-title">Mis Archivos</div>
                                        <a href="https://files.favala.es/user/files.php" class="menu-item " style="font-size:1.03rem;">
                            <i class="fas fa-folder-open" style="font-size:1.25rem; vertical-align:middle; margin-right:0.5rem;"></i> Ver mis archivos
                        </a>
                        <a href="https://files.favala.es/user/upload.php" class="menu-item ">
                            <i class="fas fa-upload"></i> Subir archivo
                        </a>
                </div>
                    </div>
        
            </div>
                <div class="main-content">
        <div class="header">
        <div class="header-left">
            <button class="mobile-menu-toggle btn btn-outline" onclick="Mimir.toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="header-title">Configuración del Sistema</h1>
        </div>
        <div class="header-actions">
            <div class="user-menu" onclick="toggleUserMenu(event)">
                <div class="user-avatar">
                    A                </div>
                <div>
                    <div style="font-weight: 500;">Administrator</div>
                    <div style="font-size: 0.8125rem; color: var(--text-muted);">
                        Administrador                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="userMenuDropdown" style="display: none; position: absolute; right: 1.5rem; top: 70px; background: white; border: 1px solid var(--border-color); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); min-width: 200px; z-index: 1000;">
        <a href="https://files.favala.es/user/profile.php" style="display: block; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-decoration: none; color: inherit;"><i class="fas fa-user"></i> Mi Perfil</a>
                                <a href="https://files.favala.es/user/2fa_setup.php" style="display: block; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-decoration: none; color: inherit;"><i class="fas fa-lock"></i> Autenticación 2FA</a>
            <a href="#" onclick="toggleMaintenance(event, true, '809efcadd2ab1cd3eaeb7aef6e3a241202eb4186c1b080a0821421d3ca659ac4')" style="display: block; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-decoration: none; color: inherit;">
                <i class="fas fa-tools"></i> 
                Activar Mantenimiento            </a>
            <a href="#" onclick="toggleConfigProtection(event, true, '809efcadd2ab1cd3eaeb7aef6e3a241202eb4186c1b080a0821421d3ca659ac4')" style="display: block; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-decoration: none; color: inherit;">
                <i class="fas fa-shield-alt"></i>
                Activar protección de configuración            </a>
                <a href="https://files.favala.es/logout.php" style="display: block; padding: 0.75rem 1rem; color: var(--danger-color); text-decoration: none;"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
    </div>
    <div class="content">
            <!-- Global config protection indicator -->
    <div style="margin-bottom:1rem;">
        <span style="font-weight:700;">Protección de configuración:</span>
        <span id="configProtectionIndicator" style="margin-left:0.75rem; display:inline-flex; align-items:center; gap:0.5rem;">
                            <i class="fas fa-lock-open" style="color:#16a34a; font-size:1.05rem;"></i>
                <span style="color:#16a34a; font-weight:600;">Desactivada</span>
                    </span>
    </div>
    
    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="809efcadd2ab1cd3eaeb7aef6e3a241202eb4186c1b080a0821421d3ca659ac4">
        
                                <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-cog"></i> General</h3>
                </div>
                <div class="card-body">
                                                                                <div class="form-group">
                        <label>
                            default_max_downloads                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="default_max_downloads" 
                                class="form-control" 
                                value="100"
                                placeholder="100"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Default maximum downloads per share                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            default_max_share_days                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="default_max_share_days" 
                                class="form-control" 
                                value="30"
                                placeholder="30"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Default maximum days for sharing                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            default_storage_quota                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="default_storage_quota" 
                                class="form-control" 
                                value="10737418240"
                                placeholder="10737418240"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Default storage quota per user in bytes (10GB)                            </small>
                                            </div>
                                    </div>
            </div>
                                            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-paint-brush"></i> Marca e Identidad</h3>
                </div>
                <div class="card-body">
                                                                                <div class="form-group">
                        <label>
                            Nombre del Sitio                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="site_name" 
                                class="form-control" 
                                value="Mimir"
                                placeholder="Mi Gestor de Archivos"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Site name displayed in header                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            brand_accent_color                                                    </label>
                        
                                                    <!-- Color picker for brand colors -->
                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <input 
                                    type="color" 
                                    id="color_brand_accent_color"
                                    value="#667eea" 
                                    style="width: 60px; height: 40px; border: 2px solid var(--border-color); border-radius: var(--radius-md); cursor: pointer;"
                                    onchange="document.getElementById('text_brand_accent_color').value = this.value; updateColorPreview();"
                                >
                                <input 
                                    type="text" 
                                    id="text_brand_accent_color"
                                    name="brand_accent_color" 
                                    class="form-control" 
                                    value="#667eea" 
                                    placeholder="#1e40af"
                                    style="flex: 1; font-family: monospace;"
                                    oninput="document.getElementById('color_brand_accent_color').value = this.value; updateColorPreview();"
                                >
                                <button 
                                    type="button" 
                                    class="btn btn-outline btn-outline--on-dark" 
                                    onclick="pickColorFromScreen('brand_accent_color')"
                                    title="Seleccionar color de la pantalla"
                                    style="padding: 0.5rem 0.75rem; height: 40px; white-space: nowrap;">
                                    <i class="fas fa-eye-dropper"></i>
                                </button>
                                <div style="width: 40px; height: 40px; border-radius: var(--radius-md); border: 2px solid var(--border-color); background: #667eea;" id="preview_brand_accent_color"></div>
                            </div>
                                                
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Accent brand color                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            brand_primary_color                                                    </label>
                        
                                                    <!-- Color picker for brand colors -->
                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <input 
                                    type="color" 
                                    id="color_brand_primary_color"
                                    value="#667eea" 
                                    style="width: 60px; height: 40px; border: 2px solid var(--border-color); border-radius: var(--radius-md); cursor: pointer;"
                                    onchange="document.getElementById('text_brand_primary_color').value = this.value; updateColorPreview();"
                                >
                                <input 
                                    type="text" 
                                    id="text_brand_primary_color"
                                    name="brand_primary_color" 
                                    class="form-control" 
                                    value="#667eea" 
                                    placeholder="#1e40af"
                                    style="flex: 1; font-family: monospace;"
                                    oninput="document.getElementById('color_brand_primary_color').value = this.value; updateColorPreview();"
                                >
                                <button 
                                    type="button" 
                                    class="btn btn-outline btn-outline--on-dark" 
                                    onclick="pickColorFromScreen('brand_primary_color')"
                                    title="Seleccionar color de la pantalla"
                                    style="padding: 0.5rem 0.75rem; height: 40px; white-space: nowrap;">
                                    <i class="fas fa-eye-dropper"></i>
                                </button>
                                <div style="width: 40px; height: 40px; border-radius: var(--radius-md); border: 2px solid var(--border-color); background: #667eea;" id="preview_brand_primary_color"></div>
                            </div>
                                                
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Primary brand color                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            brand_secondary_color                                                    </label>
                        
                                                    <!-- Color picker for brand colors -->
                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <input 
                                    type="color" 
                                    id="color_brand_secondary_color"
                                    value="#764ba2" 
                                    style="width: 60px; height: 40px; border: 2px solid var(--border-color); border-radius: var(--radius-md); cursor: pointer;"
                                    onchange="document.getElementById('text_brand_secondary_color').value = this.value; updateColorPreview();"
                                >
                                <input 
                                    type="text" 
                                    id="text_brand_secondary_color"
                                    name="brand_secondary_color" 
                                    class="form-control" 
                                    value="#764ba2" 
                                    placeholder="#1e40af"
                                    style="flex: 1; font-family: monospace;"
                                    oninput="document.getElementById('color_brand_secondary_color').value = this.value; updateColorPreview();"
                                >
                                <button 
                                    type="button" 
                                    class="btn btn-outline btn-outline--on-dark" 
                                    onclick="pickColorFromScreen('brand_secondary_color')"
                                    title="Seleccionar color de la pantalla"
                                    style="padding: 0.5rem 0.75rem; height: 40px; white-space: nowrap;">
                                    <i class="fas fa-eye-dropper"></i>
                                </button>
                                <div style="width: 40px; height: 40px; border-radius: var(--radius-md); border: 2px solid var(--border-color); background: #764ba2;" id="preview_brand_secondary_color"></div>
                            </div>
                                                
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Secondary brand color                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            Logo del Sitio                                                    </label>
                        
                                                    <!-- Logo upload -->
                            <div style="margin-bottom: 1rem;">
                                                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <input 
                                        type="file" 
                                        name="site_logo_file" 
                                        id="site_logo_file"
                                        accept="image/jpeg,image/png,image/gif,image/svg+xml,image/webp"
                                        class="form-control"
                                        style="flex: 1;"
                                        onchange="previewLogo(this)"
                                    >
                                    <button type="button" onclick="document.getElementById('site_logo_file').value=''; document.getElementById('logo_preview').style.display='none';" class="btn btn-outline btn-outline--on-dark" style="white-space: nowrap;">
                                        <i class="fas fa-times"></i> Limpiar
                                    </button>
                                </div>
                                <div id="logo_preview" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); display: inline-block;">
                                    <p style="margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Vista previa:</p>
                                    <img id="logo_preview_img" style="max-width: 200px; max-height: 100px; display: block;">
                                </div>
                                <div style="margin-top: 1rem; padding: 1rem; background: #e0f2fe; border-left: 4px solid #0ea5e9; border-radius: var(--radius-md);">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                                        <input type="checkbox" name="auto_extract_colors" value="1" checked style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="color: #0c4a6e; font-weight: 600;">
                                            <i class="fas fa-magic"></i> Extraer colores automáticamente del logo
                                        </span>
                                    </label>
                                    <p style="margin: 0.5rem 0 0 1.75rem; color: #075985; font-size: 0.8125rem;">
                                        Los colores primario, secundario y de acento se ajustarán basándose en los colores dominantes del logo
                                    </p>
                                </div>
                            </div>
                            <input type="hidden" name="site_logo" value="">
                                                
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Path to site logo                            </small>
                                            </div>
                                    </div>
            </div>
                                            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-save"></i> Almacenamiento</h3>
                </div>
                <div class="card-body">
                                                                                <div class="form-group">
                        <label>
                            allowed_extensions                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="allowed_extensions" 
                                class="form-control" 
                                value="pdf,doc,docx,xls,xlsx,ppt,pptx,txt,jpg,jpeg,png,gif,zip,rar,7z"
                                placeholder="pdf,doc,docx,xls,xlsx,jpg,png,zip"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Comma-separated allowed file extensions                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            max_file_size                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="max_file_size" 
                                class="form-control" 
                                value="536870912"
                                placeholder="536870912"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Maximum file size in bytes (512MB)                            </small>
                                            </div>
                                    </div>
            </div>
                                                                <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-server"></i> LDAP (OpenLDAP)</h3>
                </div>
                <div class="card-body">
                                        <div style="margin-bottom:1rem;">
                        <button type="button" class="btn btn-info" onclick="testLdap('ldap')">
                            <i class="fas fa-vial"></i> TEST conexión LDAP 
                        </button>
                        <span id="testLdapResult_ldap" style="margin-left:1rem;font-weight:bold;"></span>
                    </div>
                                                                                <div class="form-group">
                        <label>
                            enable_ldap                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="enable_ldap" 
                                class="form-control" 
                                value="0"
                                                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Enable LDAP authentication                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ldap_base_dn                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ldap_base_dn" 
                                class="form-control" 
                                value=""
                                placeholder="dc=ejemplo,dc=com"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                LDAP base DN                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ldap_bind_dn                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ldap_bind_dn" 
                                class="form-control" 
                                value=""
                                placeholder="cn=admin,dc=ejemplo,dc=com"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                LDAP bind DN                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ldap_bind_password                                                    </label>
                        
                                                                                                            <input 
                                type="password" 
                                name="ldap_bind_password" 
                                class="form-control" 
                                value=""
                                placeholder="••••••••"                                                            >
                                                            <small class="form-text text-muted">Dejar vacío para no cambiar la contraseña existente.</small>
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                LDAP bind password                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ldap_display_name_attribute                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ldap_display_name_attribute" 
                                class="form-control" 
                                value="cn"
                                placeholder="cn"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                LDAP display name attribute                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ldap_email_attribute                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ldap_email_attribute" 
                                class="form-control" 
                                value="mail"
                                placeholder="mail"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                LDAP email attribute                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ldap_host                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ldap_host" 
                                class="form-control" 
                                value=""
                                placeholder="ldap://ldap.ejemplo.com"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                LDAP server host                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ldap_port                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ldap_port" 
                                class="form-control" 
                                value="389"
                                placeholder="389"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                LDAP server port                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ldap_search_filter                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ldap_search_filter" 
                                class="form-control" 
                                value="(&amp;(objectClass=inetOrgPerson)(uid=%s))"
                                placeholder="(&amp;(objectClass=inetOrgPerson)(uid=%s))"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                LDAP search filter                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ldap_username_attribute                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ldap_username_attribute" 
                                class="form-control" 
                                value="uid"
                                placeholder="uid"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                LDAP username attribute                            </small>
                                            </div>
                                    </div>
            </div>
                                            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-windows"></i> Active Directory</h3>
                </div>
                <div class="card-body">
                                        <div style="margin-bottom:1rem;">
                        <button type="button" class="btn btn-info" onclick="testLdap('ad')">
                            <i class="fas fa-vial"></i> TEST conexión AD 
                        </button>
                        <span id="testLdapResult_ad" style="margin-left:1rem;font-weight:bold;"></span>
                    </div>
                                                                                <div class="form-group">
                        <label>
                            enable_ad                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="enable_ad" 
                                class="form-control" 
                                value="0"
                                                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Enable Active Directory authentication                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ad_base_dn                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ad_base_dn" 
                                class="form-control" 
                                value=""
                                placeholder="dc=empresa,dc=local"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Active Directory base DN                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ad_bind_dn                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ad_bind_dn" 
                                class="form-control" 
                                value=""
                                placeholder="cn=svc_bind,cn=Users,dc=empresa,dc=local"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Active Directory bind DN                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ad_bind_password                                                    </label>
                        
                                                                                                            <input 
                                type="password" 
                                name="ad_bind_password" 
                                class="form-control" 
                                value=""
                                placeholder="••••••••"                                                            >
                                                            <small class="form-text text-muted">Dejar vacío para no cambiar la contraseña existente.</small>
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Active Directory bind password                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ad_display_name_attribute                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ad_display_name_attribute" 
                                class="form-control" 
                                value="displayName"
                                placeholder="displayName"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Active Directory display name attribute                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ad_email_attribute                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ad_email_attribute" 
                                class="form-control" 
                                value="mail"
                                placeholder="mail"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Active Directory email attribute                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ad_group_filter                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ad_group_filter" 
                                class="form-control" 
                                value="(&amp;(objectClass=group)(member=%s))"
                                placeholder="(&amp;(objectClass=group)(member=%s))"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Active Directory group filter                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ad_host                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ad_host" 
                                class="form-control" 
                                value=""
                                placeholder="ldap://dc01.empresa.local"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Active Directory server host                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ad_port                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ad_port" 
                                class="form-control" 
                                value="389"
                                placeholder="389"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Active Directory port                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ad_require_group                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ad_require_group" 
                                class="form-control" 
                                value=""
                                placeholder="cn=Usuarios Archivos,ou=Grupos,dc=empresa,dc=local"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Active Directory required group DN                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ad_search_filter                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ad_search_filter" 
                                class="form-control" 
                                value="(&amp;(objectClass=user)(sAMAccountName=%s))"
                                placeholder="(&amp;(objectClass=user)(sAMAccountName=%s))"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Active Directory search filter                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ad_use_ssl                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ad_use_ssl" 
                                class="form-control" 
                                value="0"
                                                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Use LDAPS (SSL/TLS)                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ad_use_tls                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ad_use_tls" 
                                class="form-control" 
                                value="0"
                                                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Use StartTLS                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            ad_username_attribute                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="ad_username_attribute" 
                                class="form-control" 
                                value="sAMAccountName"
                                placeholder="sAMAccountName"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Active Directory username attribute                            </small>
                                            </div>
                                    </div>
            </div>
                                            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-envelope"></i> Correo Electrónico</h3>
                </div>
                <div class="card-body">
                                                            <div style="margin-bottom:1rem;">
                        <button type="button" class="btn btn-info" onclick="testSmtp()">
                            <i class="fas fa-paper-plane"></i> TEST correo
                        </button>
                        <span id="testSmtpResult" style="margin-left:1rem;font-weight:bold;"></span>
                    </div>
                                                            <div class="form-group">
                        <label>
                            enable_email                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="enable_email" 
                                class="form-control" 
                                value="1"
                                                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Enable email notifications                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            email_from_address                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="email_from_address" 
                                class="form-control" 
                                value="admin@favala.es"
                                placeholder="noreply@ejemplo.com"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                From email address                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            email_from_name                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="email_from_name" 
                                class="form-control" 
                                value="Admin Favala"
                                placeholder="Sistema de Archivos"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                From name                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            smtp_encryption                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="smtp_encryption" 
                                class="form-control" 
                                value="tls"
                                                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                SMTP encryption (tls/ssl)                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            smtp_host                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="smtp_host" 
                                class="form-control" 
                                value="smtp.dondominio.com"
                                placeholder="smtp.gmail.com"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                SMTP server host                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            smtp_password                                                    </label>
                        
                                                                                                            <input 
                                type="password" 
                                name="smtp_password" 
                                class="form-control" 
                                value=""
                                placeholder="••••••••"                                                            >
                                                            <small class="form-text text-muted">Dejar vacío para no cambiar la contraseña existente.</small>
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                SMTP password                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            smtp_port                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="smtp_port" 
                                class="form-control" 
                                value="587"
                                placeholder="587"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                SMTP server port                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            smtp_username                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="smtp_username" 
                                class="form-control" 
                                value="admin@favala.es"
                                placeholder="tu-email@gmail.com"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                SMTP username                            </small>
                                            </div>
                                    </div>
            </div>
                                            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-lock"></i> Autenticación 2FA (TOTP)</h3>
                </div>
                <div class="card-body">
                                                                                <div class="form-group">
                        <label>
                            2fa_device_trust_days                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="2fa_device_trust_days" 
                                class="form-control" 
                                value="30"
                                placeholder="30"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Device trust duration in days                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            2fa_grace_period_hours                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="2fa_grace_period_hours" 
                                class="form-control" 
                                value="24"
                                placeholder="24"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Grace period for new 2FA setup                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            2fa_lockout_minutes                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="2fa_lockout_minutes" 
                                class="form-control" 
                                value="15"
                                placeholder="15"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Lockout duration in minutes                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            2fa_max_attempts                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="2fa_max_attempts" 
                                class="form-control" 
                                value="3"
                                placeholder="3"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Maximum 2FA attempts before lockout                            </small>
                                            </div>
                                    </div>
            </div>
                                            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-shield-alt"></i> Duo Security</h3>
                </div>
                <div class="card-body">
                                                                                <div class="form-group">
                        <label>
                            duo_api_hostname                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="duo_api_hostname" 
                                class="form-control" 
                                value=""
                                placeholder="api-xxxxxxxx.duosecurity.com"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Duo API Hostname                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            duo_client_id                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="duo_client_id" 
                                class="form-control" 
                                value=""
                                placeholder="DIXXXXXXXXXXXXX"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Duo Client ID                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            duo_client_secret                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="duo_client_secret" 
                                class="form-control" 
                                value=""
                                placeholder="••••••••••••••••••••"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Duo Client Secret                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            duo_redirect_uri                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="duo_redirect_uri" 
                                class="form-control" 
                                value=""
                                placeholder="https://files.ejemplo.com/login_2fa_duo_callback.php"                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Duo Redirect URI                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            enable_duo                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="enable_duo" 
                                class="form-control" 
                                value="0"
                                                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Enable Duo Security 2FA                            </small>
                                            </div>
                                    </div>
            </div>
                                            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-palette"></i> Apariencia</h3>
                </div>
                <div class="card-body">
                                                                                <div class="form-group">
                        <label>
                            enable_registration                                                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Sistema</span>
                                                    </label>
                        
                                                                                                            <input 
                                type="text" 
                                name="enable_registration" 
                                class="form-control" 
                                value="0"
                                                                                            >
                                                                            
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Allow user self-registration                            </small>
                                            </div>
                                        <div class="form-group">
                        <label>
                            footer_links                                                    </label>
                        
                                                                                <textarea 
                                name="footer_links" 
                                class="form-control" 
                                rows="3"
                                placeholder="{&quot;Términos&quot;: &quot;/terms&quot;, &quot;Privacidad&quot;: &quot;/privacy&quot;, &quot;Contacto&quot;: &quot;/contact&quot;}"                                                            >[]</textarea>
                                                
                                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Footer links as JSON array                            </small>
                                            </div>
                                    </div>
            </div>
                                                
        <div style="position: sticky; bottom: 1rem; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-main) 100%); padding: 1.5rem; border-radius: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,0.15); border: 2px solid var(--border-color);">
            <button type="submit" class="btn btn-primary" style="padding: 0.875rem 2rem; font-size: 1.0625rem; font-weight: 700; box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);"><i class="fas fa-save"></i> Guardar Cambios</button>
            <a href="https://files.favala.es/admin/index.php" class="btn btn-outline btn-outline--on-dark" style="padding: 0.875rem 2rem; font-size: 1.0625rem; font-weight: 600;">Cancelar</a>
        </div>
    </form>
</div>

<script>
// Validate notification emails before submitting config form
(function(){
    var form = document.querySelector('form');
    if (!form) return;
    form.addEventListener('submit', function(e){
        try {
            // Presence marker is used for boolean controls; check the actual checkbox
            var enabledEl = document.querySelector('input[name="notify_user_creation_enabled"]');
            var enabledOn = enabledEl ? enabledEl.checked : false;
            if (!enabledOn) return;
            var emailsField = document.getElementById('notify_user_creation_emails');
            var notifyAdminsEl = document.querySelector('input[name="notify_user_creation_to_admins"]');
            var notifyAdmins = notifyAdminsEl ? notifyAdminsEl.checked : false;

            var hasEmails = false;
            if (emailsField) {
                var val = emailsField.value.trim();
                if (val !== '') {
                    var parts = val.split(',').map(function(s){ return s.trim(); }).filter(Boolean);
                    var emailRegex = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
                    for (var i=0;i<parts.length;i++) if (emailRegex.test(parts[i])) { hasEmails = true; break; }
                }
            }
            if (!hasEmails && !notifyAdmins) {
                e.preventDefault();
                alert('La notificación de creación de usuario está activada pero no hay destinatarios válidos. Añade al menos un email válido o marca "Notificar también a administradores".');
            }
        } catch (err) {
            // ignore any JS errors in validation
        }
    });
})();

<script>
function previewLogo(input) {
    const preview = document.getElementById('logo_preview');
    const previewImg = document.getElementById('logo_preview_img');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'inline-block';
        };
        
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.style.display = 'none';
    }
}

function toggleSignaturePreview() {
    const preview = document.getElementById('email_signature_preview');
    const field = document.getElementById('email_signature_field');
    if (!preview || !field) return;
    if (preview.style.display === 'none' || preview.style.display === '') {
        // Render HTML as-is (admin-provided). This is an admin-only field; trust admin.
        preview.innerHTML = field.value;
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

// Update preview live when editing
document.addEventListener('DOMContentLoaded', function() {
    const field = document.getElementById('email_signature_field');
    if (!field) return;
    field.addEventListener('input', function() {
        const preview = document.getElementById('email_signature_preview');
        if (preview && preview.style.display === 'block') {
            preview.innerHTML = field.value;
        }
    });
});

function updateColorPreview() {
    // Update color preview squares
    const colorInputs = document.querySelectorAll('input[type="text"][id^="text_"][id*="color"]');
    colorInputs.forEach(input => {
        const key = input.id.replace('text_', '');
        const preview = document.getElementById('preview_' + key);
        if (preview) {
            preview.style.background = input.value;
        }
    });
    
    // Live preview in page (optional)
    const primaryColor = document.getElementById('text_brand_primary_color');
    const secondaryColor = document.getElementById('text_brand_secondary_color');
    const accentColor = document.getElementById('text_brand_accent_color');
    
    if (primaryColor) {
        document.documentElement.style.setProperty('--brand-primary', primaryColor.value);
    }
    if (secondaryColor) {
        document.documentElement.style.setProperty('--brand-secondary', secondaryColor.value);
    }
    if (accentColor) {
        document.documentElement.style.setProperty('--brand-accent', accentColor.value);
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', updateColorPreview);

// EyeDropper API for color picking
async function pickColorFromScreen(configKey) {
    // Check if EyeDropper API is supported
    if (!window.EyeDropper) {
        alert('Tu navegador no soporta la herramienta de selección de colores (EyeDropper API).\n\nPrueba con Chrome, Edge o Opera actualizado.');
        return;
    }
    
    try {
        const eyeDropper = new EyeDropper();
        const result = await eyeDropper.open();
        
        if (result && result.sRGBHex) {
            const color = result.sRGBHex;
            
            // Update all inputs
            document.getElementById('color_' + configKey).value = color;
            document.getElementById('text_' + configKey).value = color;
            
            // Update preview
            updateColorPreview();
        }
    } catch (err) {
        // User cancelled or error occurred
        if (err.name !== 'AbortError') {
            console.error('Error al seleccionar color:', err);
        }
    }
}
</script>
<script>
function testLdap(type) {
    const btn = event.target;
    const resultSpan = document.getElementById('testLdapResult_' + type);
    btn.disabled = true;
    resultSpan.textContent = 'Probando...';
    fetch('https://files.favala.es/admin/test_ldap.php?type=' + encodeURIComponent(type))
        .then(Mimir.parseJsonResponse)
        .then(data => {
            if (data.success) {
                resultSpan.textContent = '✅ ' + data.message;
                resultSpan.style.color = '#16a34a'; // verde
            } else {
                resultSpan.textContent = '❌ ' + (data.message || 'Error desconocido');
                resultSpan.style.color = '#dc2626'; // rojo
            }
        })
        .catch((err) => {
            resultSpan.textContent = '❌ Error de conexión: ' + (err && err.message ? err.message : '');
            resultSpan.style.color = '#dc2626';
        })
        .finally(() => { btn.disabled = false; });
}
</script>

<script>
function testSmtp() {
    const btn = event.target;
    const resultSpan = document.getElementById('testSmtpResult');
    btn.disabled = true;
    resultSpan.textContent = 'Probando...';

    // Collect current form values to allow testing live edits
    const data = new FormData();
    const fields = ['smtp_host','smtp_port','smtp_encryption','smtp_username','smtp_password'];
    fields.forEach(f => {
        const el = document.querySelector('[name="' + f + '"]');
        if (el) data.append(f, el.value);
    });

    fetch('https://files.favala.es/admin/config.php?action=test_smtp', { method: 'POST', body: data })
        .then(Mimir.parseJsonResponse)
        .then(data => {
            if (data.success) {
                resultSpan.textContent = '✅ ' + (data.message || 'Conexión OK');
                resultSpan.style.color = '#16a34a';
            } else {
                let msg = data.message || 'Error desconocido';
                if (data.debug && Array.isArray(data.debug)) {
                    msg += ' — ' + data.debug.slice(0,2).join(' | ');
                }
                resultSpan.textContent = '❌ ' + msg;
                resultSpan.style.color = '#dc2626';
            }
        })
        .catch((err) => {
            resultSpan.textContent = '❌ Error de conexión: ' + (err && err.message ? err.message : '');
            resultSpan.style.color = '#dc2626';
        })
        .finally(() => { btn.disabled = false; });
}
</script>

<!-- TinyMCE integration for email signature field -->
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    var sigField = document.getElementById('email_signature_field');
    if (!sigField) return;

    tinymce.init({
        selector: '#email_signature_field',
        height: 300,
        menubar: false,
        plugins: 'link image media paste code',
        toolbar: 'undo redo | styleselect | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image | code',
        images_upload_handler: function (blobInfo, success, failure) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'https://files.favala.es/admin/upload_signature_image.php');
            // send CSRF token header
            xhr.setRequestHeader('X-CSRF-Token', '809efcadd2ab1cd3eaeb7aef6e3a241202eb4186c1b080a0821421d3ca659ac4');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var json = JSON.parse(xhr.responseText);
                        if (json.location) {
                            success(json.location);
                        } else {
                            failure('Respuesta inválida: ' + xhr.responseText);
                        }
                    } catch (e) {
                        failure('JSON inválido: ' + e.message);
                    }
                } else {
                    failure('HTTP Error: ' + xhr.status);
                }
            };
            xhr.onerror = function() { failure('Network error.'); };
            var fd = new FormData();
            fd.append('file', blobInfo.blob(), blobInfo.filename());
            xhr.send(fd);
        }
    });
});
</script>

            </div>
        </div>
        <script>
        // Global compact-mode initializer and toggle handler
        (function(){
            const KEY = 'users_compact_view_v1';
            function applyCompact(enabled){
                if (enabled) document.body.classList.add('compact-mode');
                else document.body.classList.remove('compact-mode');
                // Update all toggle buttons if present
                const btns = document.querySelectorAll('#compactToggle');
                btns.forEach(b => {
                    try { b.innerHTML = '<i class="fas fa-compress"></i> Compacto: ' + (enabled ? 'On' : 'Off'); b.title = 'Alternar vista compacta (reduce padding y oculta columnas menos importantes)'; } catch(e){}
                });
            }
            try {
                const v = localStorage.getItem(KEY);
                applyCompact(v === '1');
            } catch(e){}

            document.addEventListener('click', function(e){
                const t = e.target.closest('#compactToggle');
                if (!t) return;
                try {
                    const current = document.body.classList.contains('compact-mode');
                    const next = !current;
                    localStorage.setItem(KEY, next ? '1' : '0');
                    applyCompact(next);
                } catch(e){
                    console.error('Compact toggle error', e);
                    alert('No se pudo cambiar la vista compacta.');
                }
            });
        })();
        </script>
        <script src="https://files.favala.es/assets/js/main.js"></script>
    </body>
    </html>
    